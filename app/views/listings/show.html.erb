<%= render 'shared/verticalnavbar'%>
<!-- ジャンボトロン -->
<div class="jumbotron row-space-0" style="margin-top: -20px; background: none;">

  <!-- カルーセル -->
  <div id="myCarousel" class="carousel slide" data-ride="carousel">
    <!-- リストの点 -->
    <% if @photos.length > 1 %>
        <ol class="carousel-indicators">
          <% @photos.each do |photo| %>
              <li data-target="#myCarousel" data-slide-to="<%= photo.id %>"></li>
          <% end %>
        </ol>
    <% end %>

    <div class="carousel-inner" role="listbox">
      <% if @photos %>
          <% @photos.each do |photo| %>
              <div class="item <%= 'active' if photo.id == @photos[0].id %>">
                <%= image_tag photo.image.url(),style: "height:420px; width:100%; overflow:hidden;" %>
              </div>
          <% end %>
      <% end %>
    </div>

    <!-- 左右の矢印 -->
    <% if @photos.length > 1%>
        <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
          <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
          <span class="sr-only">Previous</span>
        </a>
        <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
          <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
          <span class="sr-only">Next</span>
        </a>
    <% end %>
  </div>

</div>

<!-- サマリー -->
<div class="container-fluid container-listing-show">
  <div class="container">
    <div class="listing-summary row-space-3 row-space-top-3">
      <div class="row">

        </div>

        <!-- 予約フォーム -->
        <div class="col-md-3">
          <div class="panel panel-default panel-show">
            <div class="panel-heading">
              <span style="font-size:16px;"><%= @listing.price %>円（一晩あたり）</span>
            </div>

            <div class="panel-body panel-real">
              <%= form_for [@listing, @listing.reservations.new], url: new_listing_reservation_path(@listing), html: {method: "get"} do |f| %>

                  <!-- これは、予約をするときに、一緒におくる、データです。-->
                  <%= f.hidden_field :listing_id, value: @listing.id %>
                  <%= f.hidden_field :price_pernight, value: @listing.price %>
                  <% if false %>
                  <%= f.hidden_field :total_price, id:'reservation_total_price' %>
                  <% end %>
                  <div class="row row-space-2">
                    <div class="col-md-6">
                      <label>Check In</label>
                      <%= f.text_field :start_date, :class => 'form-control', placeholder: '開始' %>
                    </div>

                    <div class="col-md-6">
                      <label>Check Out</label>
                      <%= f.text_field :end_date, :class => 'form-control', placeholder: '終了',disabled:true %>
                    </div>
                  </div>


                  <div id="sitter-price" class="row row-space-2 hidden">
                    <div class="col-md-8 col-xs-8">

                    </div>
                    <div class="col-md-4 col-xs-4">

                    </div>
                  </div>

                  <!-- 手数料 -->
                  <div id="applicaton-fee" class="row row-space-2 hidden">
                    <div class="col-md-8 col-xs-8">

                    </div>
                    <div class="col-md-4 col-xs-4">

                    </div>
                  </div>

                  <!-- 合計料金 -->
                  <div id="total-price" class="row row-space-2 hidden">
                    <div class="col-md-8 col-xs-8">

                    </div>
                    <div class="col-md-4 col-xs-4">

                    </div>
                  </div>

                  <!-- エラーメッセージ -->
                  <div id="duplicate-message" class="row hidden">
                    <div class="col-md-12 text-center">
                      <label class="error">その日程は予約できません</label>
                    </div>
                  </div>

                  <div class="actions text-center">
                    <%= f.submit "この日程で予約する", class: "btn btn-danger btn-wide",disabled:true %>
                  </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- メインコンテント -->
<div class="container">
  <div class="row">
    <div class="col-md-9">
      <h3 class="row-space-3">このリスティングについて</h3>
      <p>テキスト</p>
    </div>

    <div class="col-md-3">

    </div>
  </div>


  <!-- レビュー     -->


  <!-- google map    -->
  <div class="row">
    <div class="col-md-9">
      <h3 class="row-space-3">アクセス</h3>
      <div id="map"></div>
    </div>

    <div class="col-md-3">

    </div>
  </div>
  <style>
    #map{
      width: 100%;
      height: 350px;
    }

  </style>



</div>

<script>
  $('#average_star_rate').raty({
    path: '/assets',
    readOnly: true,
    // score: star
  });
</script>

<script>
  function initMap() {

    // Create the map.
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 14,
      center: {lat: 10, lng: 10},
      mapTypeId: google.maps.MapTypeId.TERRAIN
    });


    // Add the circle for this city to the map.
    var cityCircle = new google.maps.Circle({
      strokeColor: '#FF0000',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: '#FF0000',
      fillOpacity: 0.35,
      map: map,
          center: {lat: 10, lng: 10},
      radius: 500
    });

  }

</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1BoiSo2jL950_AuFzV-f9ETgKn0uQl2I&signed_in=true&callback=initMap">
</script>

<script>
  $(function() {

    //日付について、それが選択不可能なものかを決める関数
    // inArray()について:dmyがdisabledDates配列になければ-1を返す
    function disable(date){
      dmy = date.getDate() + "-" + (date.getMonth()+1) + "-" + date.getFullYear();
      return [$.inArray(dmy,disabledDates) == -1]; //trueを返す
    }

    // 不可能な日付の配列
    disabledDates = [];

    //事前にdatepickerに選択不可能な日付をセットするajax
    $.ajax({
      url: '/setdate',
      // this data is data for sending to url
      data: {'listing_id': <%= @listing.id %>},
      dataType: 'json',
      // callback argument: data is the response data
      // 下のurlを参考
      // http://stackoverflow.com/questions/4345045/javascript-loop-between-date-ranges

      // disabledDates[]にすでに予約されている日付を追加していく
      success: function(data){
        $.each(data,function(objID,objValue){
          for(var d = new Date(objValue.start_date); d <= new Date(objValue.end_date); d.setDate(d.getDate() + 1 )){
            disabledDates.push($.datepicker.formatDate('d-m-yy',d));
          }
        });

        // start_date欄がクリックされた時の処理
        $('#reservation_start_date').datepicker({
          dateFormat: 'dd-mm-yy',
          minDate: 0,
          maxDate: '3m',
          beforeShowDay: disable,
          // 日付が選択された時の処理
          onSelect: function(selected){
            $('#reservation_end_date').datepicker("option","minDate",selected);
            $('#reservation_end_date').attr('disabled',false);

            var start_date = $(this).datepicker('getDate');
            var end_date = $('#reservation_end_date').datepicker('getDate');
            var days = (end_date - start_date)/1000/60/60/24 +1 ;

            var inputs = {
              'start_date': start_date,
              'end_date': end_date,
              'listing_id':<%= @listing.id %>
            }

            // 選択日に重なりがないかチェックするajax
            $.ajax({
              url: "/duplicate",
              data: inputs,
              success: function(data){
                if (data.duplicate) {
                  // 重なりがある場合は、エラーメッセイジを表示
                  // また、合計料金,手数料を隠す
                  // 予約ボタンの押せないようにする
                  $('#duplicate-message').removeClass('hidden');
                  $('#sitter-price').addClass('hidden');
                  $('#applicaton-fee').addClass('hidden');
                  $('#total-price').addClass('hidden');
                  $('.btn-wide').attr('disabled', true);
                }else{
                  // 重なりがない場合は、エラーメッセージをかくす
                  // 合計料金をtotalに入れる
                  // total-priceを表示させる
                  $('#duplicate-message').addClass('hidden');

                  var sitter_price = days * <%= @listing.price %> ;
                  var applicaton_fee =  Math.round(sitter_price * 0.136) ;
                  var price_total = sitter_price + applicaton_fee;
                  $('#sitter-price').removeClass('hidden');
                  $('#total-price').removeClass('hidden');
                  $('#applicaton-fee').removeClass('hidden');
                  $('#sitter-price .col-md-8').text("シッター料:"+"<%= @listing.price %>"+"円"+" x "+days+"日");
                  $('#applicaton-fee .col-md-8').text("手数料:シッター料×13.6%");
                  $('#total-price .col-md-8').text("合計料金");

                  $('#sitter-price .col-md-4').text(sitter_price+"円");
                  $('#applicaton-fee .col-md-4').text(applicaton_fee+"円");
                  $('#total-price .col-md-4').text(price_total+"円");
                  $('#reservation_total_price').val(price_total);
                  $('.btn-wide').attr('disabled', false);
                }
              }
            });
          }
        });

        // end_date欄がクリックされた時の処理
        $('#reservation_end_date').datepicker({
          dateFormat: 'dd-mm-yy',
          minDate: 0,
          maxDate: '3m',
          beforeShowDay: disable,
          onSelect: function(selected){
            $('#reservation_start_date').datepicker("option","maxDate",selected);

            var start_date = $('#reservation_start_date').datepicker('getDate');
            var end_date = $(this).datepicker('getDate');
            var days = (end_date - start_date)/1000/60/60/24 +1 ;

            var inputs = {
              'start_date': start_date,
              'end_date': end_date,
              'listing_id':<%= @listing.id %>
            }

            // 選択日に重なりがないかチェックするajax
            $.ajax({
              url: "/duplicate",
              data: inputs,
              success: function(data){
                if (data.duplicate) {
                  // 重なりがある場合は、エラーメッセ-ジを表示
                  // 合計料金,手数料を隠す
                  // 予約ボタンの押せないようにする
                  $('#duplicate-message').removeClass('hidden');
                  $('#sitter-price').addClass('hidden');
                  $('#applicaton-fee').addClass('hidden');
                  $('#total-price').addClass('hidden');
                  $('.btn-wide').attr('disabled', true);
                }else{
                  // 重なりがなくokな場合は、エラーメッセージをかくす
                  // 合計料金をtotalに入れる
                  // total-priceを表示させる
                  $('#duplicate-message').addClass('hidden');

                  var sitter_price = days * <%= @listing.price %> ;
                  var applicaton_fee =  Math.round(sitter_price * 0.136) ;
                  var price_total = sitter_price + applicaton_fee;
                  $('#sitter-price').removeClass('hidden');
                  $('#total-price').removeClass('hidden');
                  $('#applicaton-fee').removeClass('hidden');
                  $('#sitter-price .col-md-8').text("シッター料:"+"<%= @listing.price %>"+"円"+" x "+days+"日");
                  $('#applicaton-fee .col-md-8').text("手数料:シッター料×13.6%");
                  $('#total-price .col-md-8').text("合計料金");

                  $('#sitter-price .col-md-4').text(sitter_price+"円");
                  $('#applicaton-fee .col-md-4').text(applicaton_fee+"円");
                  $('#total-price .col-md-4').text(price_total+"円");
                  $('#reservation_total_price').val(price_total);
                  $('.btn-wide').attr('disabled', false);
                }
              }
            });
          }
        });
      }
    });
  });
</script>





<p id="notice"><%= notice %></p>

<p>
  <strong>Home type:</strong>
  <%= @listing.home_type %>
</p>

<p>
  <strong>Room type:</strong>
  <%= @listing.listing_type %>
</p>

<p>
  <strong>Summary:</strong>
  <%= @listing.summary %>
</p>

<p>
  <strong>Address:</strong>
  <%= @listing.address %>
</p>

<p>
  <strong>Is tv:</strong>
  <%= @listing.is_tv %>
</p>

<p>
  <strong>Is kitchen:</strong>
  <%= @listing.is_kitchen %>
</p>

<p>
  <strong>Is air:</strong>
  <%= @listing.is_air %>
</p>

<p>
  <strong>Is heating:</strong>
  <%= @listing.is_heating %>
</p>

<p>
  <strong>Is internet:</strong>
  <%= @listing.is_internet %>
</p>

<p>
  <strong>Accomodate:</strong>
  <%= @listing.accomodate %>
</p>

<p>
  <strong>Bedroom:</strong>
  <%= @listing.bedroom %>
</p>

<p>
  <strong>Bathroom:</strong>
  <%= @listing.bathroom %>
</p>

<p>
  <strong>Sheet:</strong>
  <%= @listing.sheet %>
</p>

<p>
  <strong>Price:</strong>
  <%= @listing.price %>
</p>

<p>
  <strong>Active:</strong>
  <%= @listing.active %>
</p>

<p>
  <strong>User:</strong>
  <%= @listing.user_id %>
</p>

<p>
  <strong>Listing name:</strong>
  <%= @listing.listing_name %>
</p>

<p>
  <strong>Latitude:</strong>
  <%= @listing.latitude %>
</p>

<p>
  <strong>Longitude:</strong>
  <%= @listing.longitude %>
</p>

<%= link_to 'Edit', edit_listing_path(@listing) %> |
<%= link_to 'Back', listings_path %>
